DATASET_PATH=$1
OUTPUT_PATH=$2
VOC_TREE_PATH=$3
MOST_SIMILAR_IMAGES_NUM=$4

ROTATION_ESTIMATOR_TYPE="ROBUST_L1L2"
POSITION_ESTIMATOR_TYPE="LUD"
OPTIMIZE_RELATIVE_TRANSLATIONS="TRUE"
FILTER_GLOBAL_TRANSLATIONS="TRUE"
FINAL_GLOBAL_BUNDLE="TRUE"

if [ $# ge 5 ]
  $ROTATION_ESTIMATOR_TYPE=$5
fi

if [ $# ge 6 ]
  $POSITION_ESTIMATOR_TYPE=$6
fi

if [ $# ge 7 ]
  $OPTIMIZE_RELATIVE_TRANSLATIONS=$7
fi

if [ $# ge 8 ]
  $FILTER_GLOBAL_TRANSLATIONS=$8
fi

if [ $# ge 9 ]
  $FINAL_GLOBAL_BUNDLE=$9
fi

colmap feature_extractor \
  --database_path=$DATASET_PATH/database.db \
  --image_path=$DATASET_PATH/images \
  --SiftExtraction.num_threads=8 \
  --SiftExtraction.use_gpu=1 \
  --SiftExtraction.gpu_index=0

colmap vocab_tree_matcher \
  --database_path=$DATASET_PATH/database.db \
  --SiftMatching.num_threads=8 \
  --SiftMatching.use_gpu=1 \
  --SiftMatching.gpu_index=0 \
  --VocabTreeMatching.num_images=$MOST_SIMILAR_IMAGES_NUM \
  --VocabTreeMatching.num_nearest_neighbors=5 \
  --VocabTreeMatching.vocab_tree_path=$VOC_TREE_PATH

${CMAKE_SOURCE_DIR}/../bin/run_global_mapper \
  --database_path=$DATASET_PATH/database.db \
  --image_path=$DATASET_PATH/images \
  --output_path=$OUTPUT_PATH \
  --rotation_estimator_type=$ROTATION_ESTIMATOR_TYPE \
  --position_estimator_type=$POSITION_ESTIMATOR_TYPE \
  --optimize_relative_translations=$OPTIMIZE_RELATIVE_TRANSLATIONS \
  --filter_relative_translations=$FILTER_GLOBAL_TRANSLATIONS \
  --final_global_bundle=$FINAL_GLOBAL_BUNDLE
